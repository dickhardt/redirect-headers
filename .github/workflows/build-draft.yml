name: Build IETF Draft

on:
  push:
    branches: [ main ]
    paths:
      - 'draft-*.md'
      - '.github/workflows/build-draft.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'draft-*.md'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install mmark
      run: |
        wget https://github.com/mmarkdown/mmark/releases/latest/download/mmark_linux_amd64.tgz
        tar xzf mmark_linux_amd64.tgz
        sudo mv mmark /usr/local/bin/
        chmod +x /usr/local/bin/mmark
        mmark -version

    - name: Install xml2rfc
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip
        pip3 install xml2rfc

    - name: Build XML from Markdown
      run: |
        for draft in draft-*.md; do
          echo "Building ${draft}"
          mmark "${draft}" > "${draft%.md}.xml"
        done

    - name: Build HTML and TXT from XML
      run: |
        for xml in draft-*.xml; do
          echo "Building HTML and TXT from ${xml}"
          xml2rfc --html "${xml}"
          xml2rfc --text "${xml}"
        done

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: draft-outputs
        path: |
          draft-*.xml
          draft-*.html
          draft-*.txt
        retention-days: 90

    - name: Create release on tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          draft-*.xml
          draft-*.html
          draft-*.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
